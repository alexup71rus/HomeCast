# План добавления передачи звука (Android 15+)

## Цель
Передавать **звук устройства** вместе с экраном из Android-приложения в веб‑просмотр (локальный WebSocket).

## Предпосылки
- Android 15+ (минимум), устройство: Pixel 9 Pro XL (Android 16).
- Захват экрана уже работает через MediaProjection.
- Передача кадров идёт через WebSocket на локальный web viewer.

## Архитектура (верхнеуровнево)
1. **Android**: захват аудио через MediaProjection + AudioRecord.
2. **Кодирование**: PCM → Opus (или AAC) в реальном времени.
3. **Транспорт**: отправка аудио‑фреймов по WebSocket вместе с видеокадрами.
4. **Web**: декодирование аудио и воспроизведение через Web Audio API.
5. **Синхронизация**: метки времени/буферизация для минимальной задержки и плавности.

## Детальный план работ
### 1) Android захват аудио
- Создать `AudioCaptureService` или добавить в существующий capture‑поток.
- Использовать `AudioRecord` c `AudioPlaybackCaptureConfiguration`:
  - `MediaProjection` → `AudioPlaybackCaptureConfiguration.Builder(mediaProjection)`.
  - `addMatchingUsage(AudioAttributes.USAGE_MEDIA)`
  - `addMatchingUsage(AudioAttributes.USAGE_GAME)` (опционально)
- Формат: PCM 16‑бит, 48 kHz, stereo (или mono для экономии трафика).

### 2) Кодирование аудио
- Выбор кодека: **Opus** (лучшее качество/битрейт для реального времени).
- Варианты:
  - NDK‑libopus + JNI
  - готовая библиотека Opus для Android
- Целевой битрейт: 64–96 kbps (стерео), 32–48 kbps (моно).
- Размер кадра: 20 ms (960 сэмплов при 48 kHz).

### 3) Протокол сообщений WebSocket
- Расширить текущий формат сообщений:
  - `type: "audio"`, `codec: "opus"`, `ts`, `data` (base64)
- Отправка аудиокадров отдельной очередью (не блокировать видео).
- Контроль буфера и пропуск кадров при лаге.

### 4) Web воспроизведение
- Создать `AudioContext`.
- Декодировать Opus через:
  - `WebCodecs` (если доступно) **или**
  - WASM‑decoder (libopus) + ScriptProcessor/AudioWorklet.
- Буферизация: 150–300 ms (адаптивно).
- Синхронизация с видео: на уровне timestamp, компенсировать джиттер.

### 5) UI/UX
- Индикатор статуса аудио рядом с точкой подключения.
- Возможность включить/выключить звук в viewer.

### 6) Тесты
- Проверка на:
  - портрет/ландшафт
  - блокировка экрана
  - стабильность 10+ минут
  - нагрузка CPU/Battery

## Риски и ограничения
- Некоторые приложения могут блокировать захват (DRM).
- Web Audio API может требовать взаимодействие пользователя (tap) для старта звука.
- Реализация Opus в браузере зависит от наличия WebCodecs.

## Следующие шаги (на завтра)
1. Утвердить кодек (Opus) и способ декодирования в браузере.
2. Реализовать Android‑часть захвата аудио (PCM → Opus).
3. Прототип в web‑viewer с Web Audio API.

---
Если нужно — завтра уточним требования по задержке и качеству, и сразу начнём реализацию.
